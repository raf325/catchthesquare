<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Catch the Square - Mit Firebase Leaderboard</title>
  <style>
    :root{--bg1:#0f172a;--bg2:#061226;--accent:#38bdf8;--green:#22c55e;--bomb:#ef4444}
    *{box-sizing:border-box}
    body{margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;font-family:Inter,Arial,system-ui;background:radial-gradient(1200px 600px at 10% 10%, rgba(56,189,248,0.06), transparent),linear-gradient(180deg,var(--bg1),var(--bg2));color:#e6eef8}
    .bg-dots{position:fixed;inset:0;pointer-events:none;z-index:0;background-image:radial-gradient(rgba(255,255,255,0.03) 1px, transparent 1px);background-size:40px 40px;opacity:0.6;transform:translateZ(0);animation:drift 12s linear infinite}
    @keyframes drift{from{transform:translateY(0)}to{transform:translateY(-30px)}}
    .game{position:relative;z-index:1;background:linear-gradient(180deg, rgba(2,6,23,0.9), rgba(2,6,23,0.75));padding:20px;border-radius:14px;box-shadow:0 10px 30px rgba(2,6,23,0.6);width:760px;display:grid;grid-template-columns:1fr 320px;gap:20px}
    h1{margin:0 0 8px 0;font-size:20px}
    #left{padding:8px}
    #status{display:flex;justify-content:space-between;gap:10px;margin-bottom:12px}
    #field{position:relative;width:320px;height:320px;background:linear-gradient(135deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06));border-radius:10px;border:1px solid rgba(56,189,248,0.12);overflow:hidden;margin:0 auto;transition:box-shadow .18s linear, border-color .18s linear}
    .target,.bomb{position:absolute;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-weight:700;user-select:none}
    .target{background:var(--green);width:44px;height:44px;transition:left .22s ease,top .22s ease,width .18s ease,height .18s ease,transform .12s ease,box-shadow .12s ease}
    .target:active{transform:scale(.95)}
    .bomb{background:var(--bomb);width:40px;height:40px;transition:left .6s ease,top .6s ease,transform .12s ease}
    .target.gold { background: linear-gradient(135deg, #fde047, #f59e0b); box-shadow: 0 6px 18px rgba(250,204,21,0.5); color:#04202b; }
    .explosion{position:absolute;pointer-events:none;border-radius:50%;transform:translate(-50%,-50%);opacity:1;mix-blend-mode:screen;filter:drop-shadow(0 6px 10px rgba(0,0,0,.45));}
    .particle{position:absolute;border-radius:50%;pointer-events:none;will-change:transform,opacity}
    #controls{display:flex;justify-content:flex-start;gap:10px;margin-top:12px}
    button{background:var(--accent);color:#04202b;border:none;padding:8px 12px;border-radius:8px;font-weight:600;cursor:pointer}
    button:disabled{opacity:.5;cursor:default}
    #hud{display:flex;justify-content:space-between;align-items:center;margin-top:8px;font-size:13px;color:#cfeeff}
    .pill{background:rgba(255,255,255,0.02);padding:6px 8px;border-radius:8px}

    /* Right column: leaderboard */
    #right{padding:8px}
    #leaderboard{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)}
    #leaderboard h3{margin:0 0 8px 0}
    .entry{display:flex;justify-content:space-between;padding:6px 8px;border-radius:6px;margin-bottom:6px;background:rgba(255,255,255,0.01)}
    #submitScore{display:flex;gap:8px;margin-top:8px}
    input[type=text]{flex:1;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
    small.note{display:block;margin-top:8px;color:#9fc9e6}

    /* Shake animation for field */
    @keyframes shake {
      0% { transform: translate(0,0); }
      25% { transform: translate(2px, -2px); }
      50% { transform: translate(-2px, 2px); }
      75% { transform: translate(2px, 2px); }
      100% { transform: translate(0,0); }
    }
    .shake { animation: shake 0.15s linear; }

    /* Countdown big number inside square during start */
    .target.countdown { font-size:18px; background:rgba(56,189,248,0.16); color:var(--accent); width:72px; height:72px; border-radius:12px; }

    /* subtle glow on last seconds */
    .urgent { box-shadow: 0 0 30px rgba(239,68,68,0.18); border-color: rgba(239,68,68,0.6); }
  </style>
</head>
<body>
  <div class="bg-dots"></div>
  <div class="game">
    <div id="left">
      <h1>ðŸŽ¯ Catch the Square</h1>
      <div id="status">
        <div>Punkte: <strong><span id="score">0</span></strong></div>
        <div>Zeit: <strong><span id="timer">30</span>s</strong></div>
        <div>Level: <strong><span id="level">1</span></strong></div>
      </div>
      <div id="field">
        <div id="square" class="target" style="display:none"></div>
      </div>

      <div id="controls">
        <button id="startBtn">Spiel starten</button>
        <button id="stopBtn">Stopp</button>
      </div>

      <div id="hud">
        <div class="pill">Combo: <span id="combo">0</span></div>
        <div class="pill">Bomben: <span id="bombCount">0</span></div>
      </div>
    </div>

    <div id="right">
      <div id="leaderboard">
        <h3>Online Leaderboard (Top 10)</h3>
        <div id="entries">Lade...</div>
        <div id="submitScore">
          <input id="playerName" type="text" placeholder="Dein Name (max 12)" maxlength="12" />
          <button id="saveBtn">Score speichern</button>
        </div>
        <small class="note">Leaderboard benÃ¶tigt Firebase-Konfiguration (siehe Code).</small>
      </div>
    </div>
  </div>

  <!-- Firebase SDK + Leaderboard-Integration -->
  <script type="module">
    // --- WICHTIG ---
    // 1) Lege in der Firebase Console ein Projekt an (falls noch nicht geschehen).
    // 2) Aktiviere Cloud Firestore.
    // 3) Falls nÃ¶tig: Ersetze die Werte im firebaseConfig-Objekt unten mit deinen Projektwerten.
    // Hinweis: initializeApp wird hier so aufgerufen, dass ein doppeltes Initialisieren verhindert wird.

    import { initializeApp, getApps } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp, getDocs } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

    // --- DEINE FIREBASE CONFIG (falls bereits vorhanden, belasse es so) ---
    const firebaseConfig = {
      apiKey: "AIzaSyA90J97sqt1oMnYfojDEVCKgVBkN_3Ilmc",
      authDomain: "chasethesquare.firebaseapp.com",
      projectId: "chasethesquare",
      storageBucket: "chasethesquare.firebasestorage.app",
      messagingSenderId: "730109083472",
      appId: "1:730109083472:web:f52ccc4f46459e6609f655"
    };

    let db = null; // Firestore instance
    let unsubscribeLeaderboard = null; // listener

    function initFirebaseIfNeeded() {
      // Wenn db schon gesetzt, ist Firebase bereits initialisiert
      if (db) return true;
      try {
        // getApps() gibt eine Liste initialisierter Apps zurÃ¼ck; initialisiere nur, wenn noch keine existiert
        if (!getApps || getApps().length === 0) {
          initializeApp(firebaseConfig);
        }
        db = getFirestore();
        console.log('Firebase initialisiert');
        return true;
      } catch (e) {
        console.error('Firebase Init Error', e);
        return false;
      }
    }

    // DOM refs
    const field = document.getElementById('field');
    const square = document.getElementById('square');
    const scoreEl = document.getElementById('score');
    const timerEl = document.getElementById('timer');
    const levelEl = document.getElementById('level');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const comboEl = document.getElementById('combo');
    const bombCountEl = document.getElementById('bombCount');
    const entriesEl = document.getElementById('entries');
    const playerNameInput = document.getElementById('playerName');
    const saveBtn = document.getElementById('saveBtn');

    // Game state
    let score = 0, timeLeft = 30, gameStarted = false;
    let squareSpeed = 1000, comboCount = 0;
    let interval = null, obstaclesInterval = null, countdown = null;
    const obstacles = []; const maxObstacles = 3;
    const obstaclesMoveSpeed = 2000;
    let lastHitTime = 0;

    // Audio helper (small beeps) - optional, lightweight
    const audioCtx = (typeof AudioContext !== 'undefined') ? new AudioContext() : null;
    function playBeep(frequency = 440, duration = 0.06, type = 'sine', gain = 0.02) {
      if(!audioCtx) return;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = type;
      o.frequency.value = frequency;
      g.gain.value = gain;
      o.connect(g); g.connect(audioCtx.destination);
      o.start();
      setTimeout(()=>{ o.stop(); }, duration*1000);
    }

    function randomPosition(element) {
      const maxX = field.clientWidth - element.offsetWidth;
      const maxY = field.clientHeight - element.offsetHeight;
      const x = Math.random() * Math.max(0, maxX);
      const y = Math.random() * Math.max(0, maxY);
      element.style.left = x + 'px'; element.style.top = y + 'px';
    }

    function createObstacles() {
      // remove existing
      obstacles.forEach(o => { if(field.contains(o)) field.removeChild(o); });
      obstacles.length = 0;
      for (let i=0;i<maxObstacles;i++){
        const bomb = document.createElement('div');
        bomb.className='bomb';
        randomPosition(bomb);
        field.appendChild(bomb);
        obstacles.push(bomb);
        bomb.addEventListener('click',(e)=>{
          if(!gameStarted) return;
          e.stopPropagation();
          const rect = bomb.getBoundingClientRect();
          const fxX = rect.left + rect.width/2 - field.getBoundingClientRect().left;
          const fxY = rect.top + rect.height/2 - field.getBoundingClientRect().top;
          explodeBomb(fxX,fxY);
          score = Math.max(0, score - 4);
          scoreEl.textContent = score;
          comboCount = 0;
          comboEl.textContent = comboCount;
          updateLevelDisplay();
          playBeep(120, 0.12, 'sawtooth', 0.06);
          // reposition after explosion
          setTimeout(()=>{ if(field.contains(bomb)) randomPosition(bomb); },700);
        });
      }
      bombCountEl.textContent = obstacles.length;
      if(obstaclesInterval) clearInterval(obstaclesInterval);
      obstaclesInterval = setInterval(()=>{ obstacles.forEach(b=>randomPosition(b)); }, obstaclesMoveSpeed);
    }

    function updateLevelDisplay(){
      const lvl = Math.floor(score/10)+1;
      levelEl.textContent = lvl;
      // Schwierigkeit skalieren: Square-Speed reduziert (schneller)
      squareSpeed = Math.max(300, 1000 - lvl * 80);
      // Wenn ein interval existiert, resetze es mit neuem Speed
      if(interval){ clearInterval(interval); interval = setInterval(()=>placeSquare(true), squareSpeed); }
    }

    function burstParticles(x,y,color='#9ef0b6',count=10){
      for(let i=0;i<count;i++){
        const p = document.createElement('div');
        p.className='particle';
        const size = 6 + Math.random()*10;
        p.style.width = size+'px';
        p.style.height = size+'px';
        p.style.background = color;
        p.style.left = x+'px';
        p.style.top = y+'px';
        p.style.opacity = '1';
        p.style.transform = 'translate(-50%,-50%) scale(1)';
        field.appendChild(p);
        const angle = Math.random()*Math.PI*2;
        const speed = 40 + Math.random()*80;
        const dx = Math.cos(angle)*speed;
        const dy = Math.sin(angle)*speed;
        requestAnimationFrame(()=>{ p.style.transition = 'transform 600ms cubic-bezier(.18,.89,.32,1), opacity 600ms linear'; p.style.transform = `translate(${dx}px,${dy}px) scale(0.2)`; p.style.opacity = '0'; });
        setTimeout(()=>{ if(field.contains(p)) field.removeChild(p); },700);
      }
    }

    function explodeBomb(x,y){
      const el = document.createElement('div');
      el.className='explosion';
      el.style.left = x+'px';
      el.style.top = y+'px';
      el.style.width='20px';
      el.style.height='20px';
      el.style.background='radial-gradient(circle at 30% 30%, rgba(255,200,80,0.9), rgba(255,120,33,0.6) 30%, rgba(255,60,60,0.2) 60%, transparent 70%)';
      field.appendChild(el);
      requestAnimationFrame(()=>{
        el.style.transition='width 420ms ease-out,height 420ms ease-out,opacity 420ms ease-out';
        el.style.width='200px';
        el.style.height='200px';
        el.style.opacity='0';
        el.style.marginLeft='-100px';
        el.style.marginTop='-100px';
      });
      burstParticles(x,y,'#ffb86b',18);
      setTimeout(()=>{ if(field.contains(el)) field.removeChild(el); },450);
    }

    function placeSquare(isAuto=false){
      if(isAuto){
        comboCount=0;
        comboEl.textContent = comboCount;
      }
      // remove countdown class if present
      square.classList.remove('countdown');
      // decide if gold square spawns
      square.classList.remove('gold');
      if (Math.random() < 0.12) square.classList.add('gold'); // ~12% chance
      randomPosition(square);
      if(interval) clearInterval(interval);
      interval = setInterval(()=>placeSquare(true), squareSpeed);
    }

    // square click handling (main game action)
    square.addEventListener('click',(e)=>{
      if(!gameStarted) return;
      e.stopPropagation();
      const rect = square.getBoundingClientRect();
      const fxX = rect.left + rect.width/2 - field.getBoundingClientRect().left;
      const fxY = rect.top + rect.height/2 - field.getBoundingClientRect().top;

      // timing for "Perfect / Ultra" bonuses
      const now = Date.now();
      const delta = lastHitTime ? (now - lastHitTime) : Infinity;
      lastHitTime = now;

      comboCount++;
      comboEl.textContent = comboCount;

      // base points
      let points = 1;
      // reward for combos
      if (comboCount > 1) points += comboCount;

      // Perfect / Ultra bonuses for very fast consecutive hits
      let bonus = 0;
      if (delta < 200) { bonus = 4; /* Ultra */ }
      else if (delta < 350) { bonus = 2; /* Perfect */ }

      // Gold square adds flat bonus
      if (square.classList.contains('gold')) {
        points += 5;
        burstParticles(fxX, fxY, '#fde68a', 25);
        playBeep(880, 0.06, 'triangle', 0.06);
      } else {
        playBeep(520, 0.04, 'sine', 0.02);
      }

      score += points + bonus;
      if (bonus > 0) {
        // visual emphasis on bonus
        burstParticles(fxX, fxY, '#7dd3fc', 20);
        field.classList.add('shake');
        setTimeout(()=>field.classList.remove('shake'),150);
      }

      scoreEl.textContent = score;
      updateLevelDisplay();

      // subtle press feedback
      square.style.transform='scale(0.92)';
      setTimeout(()=>square.style.transform='scale(1)',80);

      // scale difficulty dynamically (square gets slightly smaller every 10 points)
      if(score % 10 === 0 && square.offsetWidth > 24){
        const newW = Math.max(20, square.offsetWidth - 5);
        const newH = Math.max(20, square.offsetHeight - 5);
        square.style.width = newW+'px';
        square.style.height = newH+'px';
        // restart placement interval with new speed (updateLevelDisplay already adjusts speed)
        if(interval){ clearInterval(interval); interval = setInterval(()=>placeSquare(true), squareSpeed); }
      }

      // place next immediately (not auto)
      placeSquare(false);
    });

    // clicking empty area should reset combo (penalty for misses)
    field.addEventListener('click', ()=>{
      if(!gameStarted) return;
      comboCount = 0;
      comboEl.textContent = comboCount;
      // small negative feedback
      field.classList.add('shake');
      setTimeout(()=>field.classList.remove('shake'),120);
      playBeep(180, 0.06, 'sine', 0.03);
    });

    function startCountdownThenStartGame(){
      startBtn.disabled = true;
      square.style.display = 'block';
      square.classList.add('countdown');
      square.style.width = '72px';
      square.style.height = '72px';
      let c = 3;
      square.textContent = c;
      const cd = setInterval(()=>{
        c--;
        if(c > 0){ square.textContent = c; playBeep(520 + c*80, 0.08, 'sine', 0.03); }
        else if(c === 0){ square.textContent = 'GO!'; playBeep(880, 0.08, 'triangle', 0.06); field.classList.add('shake'); setTimeout(()=>field.classList.remove('shake'),140); }
        else {
          clearInterval(cd);
          square.textContent = '';
          square.classList.remove('countdown');
          // start actual game
          realStart();
        }
      },700);
    }

    function realStart(){
      // set initial state
      score = 0; scoreEl.textContent = score;
      timeLeft = 30; timerEl.textContent = timeLeft;
      gameStarted = true;
      comboCount = 0; comboEl.textContent = 0;
      squareSpeed = 1000;
      square.style.width = '44px';
      square.style.height = '44px';
      square.style.display = 'block';
      placeSquare(false);
      createObstacles();
      if(countdown) clearInterval(countdown);
      countdown = setInterval(()=>{
        timeLeft--;
        timerEl.textContent = timeLeft;
        // last 5 seconds visual urgent
        if(timeLeft <= 5){
          field.classList.add('urgent');
          playBeep(420 + timeLeft*30, 0.04, 'sawtooth', 0.02);
        }
        if(timeLeft <= 0){
          stopGame();
          showSavePrompt();
        }
      },1000);
      startBtn.disabled = true;
      stopBtn.disabled = false;
    }

    function startGame(){
      // trigger start countdown
      if(gameStarted) return;
      // resume audio context on user gesture (some browsers require it)
      if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
      startCountdownThenStartGame();
    }

    function stopGame(){
      gameStarted=false;
      if(interval){ clearInterval(interval); interval=null; }
      if(obstaclesInterval){ clearInterval(obstaclesInterval); obstaclesInterval=null; }
      if(countdown){ clearInterval(countdown); countdown=null; }
      square.style.display='none';
      // remove obstacles
      obstacles.forEach(o=>{ if(field.contains(o)) field.removeChild(o); });
      obstacles.length=0;
      bombCountEl.textContent=0;
      startBtn.disabled=false;
      stopBtn.disabled=true;
      // reset visuals
      field.classList.remove('urgent');
      // reset square size
      square.style.width='44px';
      square.style.height='44px';
      // clear any temporary classes
      square.classList.remove('gold');
      lastHitTime = 0;
    }

    // --- Leaderboard functions ---
    async function submitScoreToFirestore(name, pts){
      if(!db) return alert('Firebase ist nicht konfiguriert. Bitte firebaseConfig im Code ergÃ¤nzen.');
      if(!name) name='Anonym';
      try{
        await addDoc(collection(db,'leaderboard'), { name, score: pts, createdAt: serverTimestamp() });
        alert('Score gespeichert!');
      }catch(e){
        console.error('Speichern fehlgeschlagen',e);
        alert('Speichern fehlgeschlagen. Konsole prÃ¼fen.');
      }
    }

    function showSavePrompt(){
      // focus name input
      playerNameInput.focus();
    }

    function renderEntries(docs){
      if(!docs) return;
      entriesEl.innerHTML='';
      docs.forEach((d,idx)=>{
        const data = d.data();
        const el = document.createElement('div');
        el.className='entry';
        el.innerHTML = `<div>${idx+1}. ${escapeHtml(data.name||'Anonym')}</div><div>${data.score}</div>`;
        entriesEl.appendChild(el);
      });
    }

    function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // initialize Firebase and start listening to leaderboard (top 10)
    function startLeaderboardRealtime(){
      if(!initFirebaseIfNeeded()) { entriesEl.textContent='Firebase nicht konfiguriert. Leaderboard offline.'; return; }
      const q = query(collection(db,'leaderboard'), orderBy('score','desc'), limit(10));
      if(unsubscribeLeaderboard) unsubscribeLeaderboard();
      unsubscribeLeaderboard = onSnapshot(q, snapshot => { renderEntries(snapshot.docs); });
    }

    // non-realtime fallback: load once
    async function loadLeaderboardOnce(){
      if(!initFirebaseIfNeeded()) { entriesEl.textContent='Firebase nicht konfiguriert. Leaderboard offline.'; return; }
      const q = query(collection(db,'leaderboard'), orderBy('score','desc'), limit(10));
      const snap = await getDocs(q);
      renderEntries(snap.docs);
    }

    // wire save button
    saveBtn.addEventListener('click', async ()=>{
      const name = playerNameInput.value.trim().substring(0,12);
      if(!initFirebaseIfNeeded()){
        alert('Firebase ist nicht konfiguriert. Bitte firebaseConfig im Code ergÃ¤nzen.');
        return;
      }
      await submitScoreToFirestore(name, score);
      playerNameInput.value='';
      // leaderboard aktualisiert automatisch durch listener
    });

    // try to start realtime listener on load (will show offline msg if not configured)
    startLeaderboardRealtime();

    // init listeners for game buttons
    startBtn.addEventListener('click',startGame);
    stopBtn.addEventListener('click',stopGame);
    stopBtn.disabled=true;

    // keep correct placement on resize
    window.addEventListener('resize',()=>{
      if(gameStarted) placeSquare(true);
    });

    // cleanup on unload
    window.addEventListener('beforeunload', ()=>{
      if(interval) clearInterval(interval);
      if(obstaclesInterval) clearInterval(obstaclesInterval);
      if(countdown) clearInterval(countdown);
      if(unsubscribeLeaderboard) unsubscribeLeaderboard();
    });
  </script>
</body>
</html>
